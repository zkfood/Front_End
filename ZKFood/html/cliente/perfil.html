<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Meu Perfil</title>

    <link rel="stylesheet" href="../../css/homePosLogin.css">
    <link rel="stylesheet" href="../../css/perfil.css">

    <link rel="stylesheet" href="../../css/responsividade/homePosLogin-responsivo.css">
    <link rel="stylesheet" href="../../css/responsividade/perfil-responsivo.css">

    <link rel="icon" href="../../assets/logo-icon.png" type="image/png">

    <script src="../../js/perfil.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@100..900&display=swap"
        rel="stylesheet">

    <script src="../../js/logoff.js"></script>
</head>

<body>
    <div class="container_navbar">
        <div class="parte_superior_navbar">
            <div class="img_voltar"> <a href="javascript:history.back()"><img src="../../assets/de-volta.png"
                        alt="Seta para voltar a página"></a></div>
            <div class="img_logo"><a href="./home_pos_login.html"><img src="../../assets/logo.png"
                        alt="Logo do ZKfood"></a></div>
                        <div class="container_pesquisa">
                            <div class="search-container" style="position: relative; width: 100%;">
                                <img src="../../assets/lupa.png" alt="Ícone de Busca" class="search-icon" id="searchIcon">
                                <input type="text" id="searchInput" placeholder="Pesquisar produtos..."
                                    style="width: 100%; padding: 10px; font-size: 16px;">
                            </div>
                            <div id="suggestions" class="suggestions-container"></div>
                        </div>
            <div class="container_favoritos_carrinho">
                <div class="container_favoritos">
                    <a href="favoritos.html"> <img src="../../assets/coracao.png"
                            alt="Icone de coração para sinalizar favoritos"></a>
                </div>
                <div class="container_carrinho">
                    <a href="carrinho.html"> <img src="../../assets/carrinho-carrinho.png"
                            alt="Icone de carrinho de mercado para sinalizar itens na lista de compras"> </a>
                </div>
            </div>
            <div class="profile_home">
                <a class="perfil" href="perfil.html"
                    style="background-image: url(../../assets/icon-user-branco.png);"></a>
                <a class="logoff" onclick="logoff()"></a>
            </div>
        </div>
        <div class="parte_inferior_navbar">
            <ul class="menu">
                <li><a href="home_pos_login.html">
                        <p>Página Inicial</p>
                    </a></li>
                <li><a href="cardapio.html">Cardápio</a></li>
                <li><a href="historico-pedidos.html">Meus Pedidos</a></li>
                <li><a href="cadastro_endereco.html">Cadastrar Endereço</a></li>
            </ul>
        </div>
    </div>

    <!-- Navbar Inferior na RESPONSIVIDADE -->
    <div class="bottom-nav">
        <a href="./home_pos_login.html">
            <img src="../../assets/icons-responsivo/icon-casa.png" alt="Icone de casa retratando tela inicial no menu">
            <span>Inicio</span>
        </a>
        <a href="./cardapio.html">
            <img src="../../assets/icons-responsivo/icon-garfo.png"
                alt="Icone de garfo retratando tela de cardápio no menu">
            <span>Cardápio</span>
        </a>
        <a href="./carrinho.html">
            <img src="../../assets/icons-responsivo/icon-carrinho.png"
                alt="Icone de carrinho retratando tela de carrinho no menu">
            <span>Carrinho</span>
        </a>
        <a href="./historico-pedidos.html">
            <img src="../../assets/icons-responsivo/icon-documento.png"
                alt="Icone de documento retratando tela de status do pedido no menu">
            <span>Pedidos</span>
        </a>
        <a href="./cadastro_endereco.html">
            <img src="../../assets/icons-responsivo/icon-endereco.png"
                alt="Icone de endereço retratando tela de cadastro de endereço no menu">
            <span>Endereço</span>
        </a>

    </div>


    <div class="container">
        <div class="sub-navbar">
            <button id="btnPerfil" class="nav-button active">Meu Perfil</button>
            <button id="btnEnderecos" class="nav-button">Meus Endereços</button>
        </div>
        <!-- <div class="listra-amarela"></div> -->
        <div class="card-perfil" id="cardPerfil">
            <img src="../../assets/user.png" alt="icone de usuário para representar o cliente">
            <h1 id="nome_titulo">Usuario</h1>
            <div class="container-usuario">
                <div class="info-usuario">
                    <p id="nome">Nome:</p>
                    <p></p> <!-- Campo onde o nome será exibido -->
                    <br>
                    <p id="telefone">Telefone:</p>
                    <p></p> <!-- Campo onde o primeiro telefone será exibido -->
                </div>
                <div class="info-usuario">
                    <p id="cpf">CPF:</p>
                    <p></p> <!-- Campo onde o CPF será exibido -->
                    <br>
                    <p id="telefone2">Telefone 2:</p>
                    <p></p> <!-- Campo onde o segundo telefone será exibido -->
                </div>
                <div class="info-usuario">
                    <p id="email">Email:</p>
                    <p></p> <!-- Campo onde o email será exibido -->
                    <br>
                    <p id="senha">Senha:</p>
                    <p>*********</p>
                </div>
            </div>
            <button class="botao-azul" onclick="editarInformacoes()">Editar</button>
        </div>

        <div class="container-listar-enderecos" id="cardEndereco" style="display: none;">
            <div class="container-endereco">
                <div id="retorno_de_dados">
                </div>
            </div>
        </div>
    </div>

    <div id="popup" class="popup">
        <div class="popup-background">
            <div class="popup-content">
                <span class="close" onclick="closePopup()">&times;</span>
                <img id="popup-icon" src="" alt="Icon">
                <h2 id="popup-title" class="popup-title"></h2>
                <p id="popup-message" class="popup-message"></p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-top">
            <img src="../../assets/Vector-ondas-footer.png" alt="Ondas para divisão de telas">
        </div>
        <div class="footer">
            <div class="footer-paginas">
                <div class="logo-footer">
                    <img src="../../assets/logo-icon.png" alt="logo da empresa ZKfood">
                </div>

                <div class="bloco-footer">
                    <a href="./home_pos_login.html">Home</a>
                    <a href="./cardapio.html">Cardápio</a>
                </div>

                <div class="bloco-footer">
                    <a href="./carrinho.html">Carrinho</a>
                    <a href="./historico-pedidos.html">Meus Pedidos</a>
                </div>

                <div class="bloco-footer">
                    <a href="./favoritos.html">Favoritos</a>
                    <a href="./perfil.html">Perfil</a>
                </div>
            </div>

            <div class="linha"></div>

            <div class="redes-sociais">
                <a href="https://www.facebook.com/share/18D1CNrSUq/?mibextid=LQQJ4d"><img
                        src="../../assets/Facebook.png" alt="Icone Facebook"></a>
                <a href="https://wa.me/5511986744335"><img src="../../assets/WhatsApp.png" alt="Icone WhatsApp"></a>
                <a href="https://www.instagram.com/restaurante.do_zeca?igsh=MWNvMzd1ZDA0em1jMA=="><img
                        src="../../assets/Instagram.png" alt="Icone Instagram"></a>
            </div>

            <div class="informacoes">
                <p><a href="https://drive.google.com/file/d/1yQBSvnm8qGFnMTT33sv2RFl_KKAw6n5r/view?usp=sharing">Termos e Condições</a></p>
                <p> | </p>
                <p><a href="https://www.gov.br/governodigital/pt-br/acessibilidade-e-usuario/vlibras">Acessibilidade</a>
                </p>
                <p> | </p>
                <p><a href="#">Suporte</a></p>
                <p> | </p>
                <p>Developed by © VisionarySolutions, 2024. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../../js/barraPesquisa.js"></script>
</body>

</html>
<script>

    let editandoEndereco = false;
    // Alterna entre o card de perfil e o de endereço
    document.getElementById('btnPerfil').addEventListener('click', function () {
        document.getElementById('cardPerfil').style.display = 'flex';
        document.getElementById('cardEndereco').style.display = 'none';
    });
    document.getElementById('btnEnderecos').addEventListener('click', function () {
        document.getElementById('cardPerfil').style.display = 'none';
        document.getElementById('cardEndereco').style.display = 'flex';
    });
    // Alterando o botão do menu que estara ativo
    const navButtons = document.querySelectorAll('.nav-button');
    navButtons.forEach(button => {
        button.addEventListener('click', function () {
            // Remove a classe 'active' de todos os botões
            navButtons.forEach(btn => btn.classList.remove('active'));
            // Adiciona a classe 'active' ao botão clicado
            this.classList.add('active');
            // Alterna entre as seções
            if (this.id === 'btnPerfil') {
                document.getElementById('cardPerfil').style.display = 'flex';
                document.getElementById('cardEndereco').style.display = 'none';
            } else if (this.id === 'btnEnderecos') {
                document.getElementById('cardPerfil').style.display = 'none';
                document.getElementById('cardEndereco').style.display = 'flex';
            }
        });
    });




    document.addEventListener("DOMContentLoaded", function () {
        let editando = false;
        let editandoEndereco = false;

        // Referências aos elementos
        const btnPerfil = document.getElementById('btnPerfil');
        const btnEnderecos = document.getElementById('btnEnderecos');
        const cardPerfil = document.getElementById('cardPerfil');
        const cardEndereco = document.getElementById('cardEndereco');
        const navButtons = document.querySelectorAll('.nav-button');

        // Funções para alternar entre os cards
        function mostrarCardPerfil() {
            cardPerfil.style.display = 'flex';
            cardEndereco.style.display = 'none';
        }

        function mostrarCardEndereco() {
            cardPerfil.style.display = 'none';
            cardEndereco.style.display = 'flex';
        }

        // Event listeners para os botões
        btnPerfil.addEventListener('click', mostrarCardPerfil);
        btnEnderecos.addEventListener('click', mostrarCardEndereco);

        // Alternar botão ativo no menu
        navButtons.forEach(button => {
            button.addEventListener('click', function () {
                // Remove a classe 'active' de todos os botões
                navButtons.forEach(btn => btn.classList.remove('active'));
                // Adiciona a classe 'active' ao botão clicado
                this.classList.add('active');
            });
        });

        // Carregar dados do perfil

        const usuario = JSON.parse(sessionStorage.getItem('usuario'));
        const telefones = JSON.parse(sessionStorage.getItem('telefones'));
        if (usuario) {
            document.getElementById('nome_titulo').innerHTML = usuario.nome;
            document.getElementById('nome').nextElementSibling.innerText = usuario.nome || 'Não encontrado';
            document.getElementById('cpf').nextElementSibling.innerText = usuario.cpf || 'Não encontrado';
            document.getElementById('email').nextElementSibling.innerText = usuario.email || 'Não encontrado';
        } else {
            document.getElementById('nome').nextElementSibling.innerText = 'Não encontrado';
            document.getElementById('cpf').nextElementSibling.innerText = 'Não encontrado';
            document.getElementById('email').nextElementSibling.innerText = 'Não encontrado';
        }
        if (telefones && telefones.length > 0) {
            document.getElementById('telefone').nextElementSibling.innerText = telefones[0].numero || 'Não encontrado';
            document.getElementById('telefone2').nextElementSibling.innerText = telefones.length > 1 ? telefones[1].numero : 'Não encontrado';
        } else {
            document.getElementById('telefone').nextElementSibling.innerText = 'Não encontrado';
            document.getElementById('telefone2').nextElementSibling.innerText = 'Não encontrado';
        }

        // Função para limpar valores undefined
        function limparUndefined(dado) {
            return dado === undefined || dado === "" ? null : dado;
        }

        // Função para editar informações do perfil
        document.querySelector('.botao-azul').addEventListener('click', function () {
            const usuarioSession = JSON.parse(sessionStorage.getItem('usuario'));
            const usuarioContainer = document.querySelector('.container-usuario');

            if (!editando) {
                const nome = document.getElementById('nome').nextElementSibling.innerText;
                const telefone = document.getElementById('telefone').nextElementSibling.innerText;
                const cpf = document.getElementById('cpf').nextElementSibling.innerText;
                const telefone2 = document.getElementById('telefone2').nextElementSibling.innerText;
                const email = document.getElementById('email').nextElementSibling.innerText;
                const senha = document.getElementById('senha').nextElementSibling.innerText;
                usuarioContainer.innerHTML = `
                <div class="info-usuario">
                    <p id="nome">Nome:</p>
                    <input type="text" id="inputNome" value="${nome}">
                    <br>
                    <p id="telefone">Telefone:</p>
                    <input type="tel" id="inputTelefone" value="${telefone}">
                </div>
                <div class="info-usuario">
                    <p id="cpf">CPF:</p>
                    <input type="text" id="inputCpf" value="${cpf}">
                    <br>
                    <p id="telefone2">Telefone 2:</p>
                    <input type="tel" id="inputTelefone2" value="${telefone2}">
                </div>
                <div class="info-usuario">
                    <p id="email">Email:</p>
                    <input type="email" id="inputEmail" value="${email}">
                    <br>
                    <p id="senha">Senha:</p>
                    <input type="password" id="inputSenha" value="${senha}">
                </div>
            `;
                this.innerText = 'Salvar';
                editando = true;
            } else {
                const nome = limparUndefined(document.getElementById('inputNome').value);
                const telefone = limparUndefined(document.getElementById('inputTelefone').value);
                const cpf = limparUndefined(document.getElementById('inputCpf').value);
                const telefone2 = limparUndefined(document.getElementById('inputTelefone2').value);
                const email = limparUndefined(document.getElementById('inputEmail').value);
                const senha = limparUndefined(document.getElementById('inputSenha').value);
                // Atualizando sessionStorage
                const novosDadosUsuario = {
                    id: usuarioSession.id,
                    nome: nome,
                    cpf: cpf,
                    email: email
                };
                sessionStorage.setItem('usuario', JSON.stringify(novosDadosUsuario));
                const telefones = [
                    { id: 1, numero: telefone },
                    { id: 2, numero: telefone2 }
                ];
                sessionStorage.setItem('telefones', JSON.stringify(telefones));
                // Requisição PATCH para atualizar o usuário
                fetch(`http://localhost:8080/usuarios/${usuarioSession.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(novosDadosUsuario)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro na atualização do usuário');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Usuário atualizado:', data);
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                    });
                // Atualização dos telefones
                telefones.forEach(telefone => {
                    fetch(`http://localhost:8080/usuarios/${usuarioSession.id}/telefones/${telefone.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ numero: telefone.numero })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Erro na atualização do telefone com ID ${telefone.id}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(`Telefone ${telefone.id} atualizado:`, data);
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                        });
                });
                // Atualizar a visualização com os novos dados
                nome_titulo.innerHTML = nome
                usuarioContainer.innerHTML = `
                <div class="info-usuario">
                    <p id="nome">Nome:</p>
                    <p>${nome}</p>
                    <br>
                    <p id="telefone">Telefone:</p>
                    <p>${telefone}</p>
                </div>
                <div class="info-usuario">
                    <p id="cpf">CPF:</p>
                    <p>${cpf}</p>
                    <br>
                    <p id="telefone2">Telefone 2:</p>
                    <p>${telefone2}</p>
                </div>
                <div class="info-usuario">
                    <p id="email">Email:</p>
                    <p>${email}</p>
                    <br>
                    <p id="senha">Senha:</p>
                    <p>${senha}</p>
                </div>
            `;
                this.innerText = 'Editar';
                editando = false;
            }
        });
    });

    let editando = false

    let idUsuario = sessionStorage.getItem('idUsuario');

    async function buscar() {
        if (idUsuario) {
            const url = `http://localhost:8080/usuarios/${idUsuario}/enderecos`;
            const resposta = await fetch(url);
            if (resposta.ok) {
                const dados = await resposta.json();
                console.log(dados);
                const div_resposta = document.getElementById("retorno_de_dados");
                if (dados.length <= 0) {
                    div_resposta.innerHTML = `
                    <!-- Card caso a pessoa ainda não tenha nenhum endereço cadastrado -->
                    <div class="container-sem-endereco">
                        <div class="container-sem-endereco">
                            <div class="card-sem-endereco">
                                <h1>Nenhum endereço cadastrado <span>:( </span></h1>
                                <p>Oops, parece que você ainda não cadastrou nenhum endereço para nossa equipe entregar o seu pedido.</p>
                                <a class="botao-azul" href="./cadastro_endereco.html">Cadastrar Endereço</a>
                            </div>
                        </div>
                    </div>
                `;
                } else {
                    div_resposta.innerHTML = `
                    <div class="container-endereco-titulo">
                        <h1>Seus <span>Endereços Cadastrados</span></h1>
                    </div>
                    <div id="container_lista_enderecos"></div>`;
                    const enderecos = document.getElementById("container_lista_enderecos");
                    enderecos.innerHTML = dados.map(renderizarCardEndereco).join('');
                    enderecos.innerHTML += `<a class="botao-azul" id="botaoContinuar" href="./pagamento.html" style="display: none;">Continuar</a>`;
                }
            } else {
                console.log('Erro ao buscar os dados');
            }
        } else {
            console.log('ID do usuário não encontrado no sessionStorage.');
        }
    }

    function renderizarCardEndereco(endereco) {
        return `
        <div id="card-endereco-${endereco.id}" class="card-endereco" onclick="selecionarCard(this, ${endereco.id})">
            <div class="container-endereco">
                <div class="conteudo-pai">
                    <div class="endereco-conteudo">
                        <div class="informacao-endereco">
                            <span class="info-rua">${endereco.rua}, ${endereco.numero} - ${endereco.complemento}</span>
                            <span class="info-cep">${endereco.bairro}, São Paulo, SP - ${endereco.cep}</span>
                        </div>
                    </div>
                    <button class="botao-excluir" onclick="excluirEndereco(${endereco.id}); event.stopPropagation();">Excluir</button>
                    <button class="botao-editar" onclick="editarEndereco(${endereco.id}); event.stopPropagation();">Editar</button>
                </div>

            </div>
        </div>`;
    }

    function editarEndereco(idEndereco) {
        const enderecoCard = document.getElementById(`card-endereco-${idEndereco}`);
        const enderecoRua = enderecoCard.querySelector('.info-rua').innerText.split(', ')[0];
        const enderecoNumero = enderecoCard.querySelector('.info-rua').innerText.split(', ')[1].split(' - ')[0];
        const enderecoComplemento = enderecoCard.querySelector('.info-rua').innerText.split(' - ')[1];
        const enderecoBairro = enderecoCard.querySelector('.info-cep').innerText.split(', ')[0];
        const enderecoCep = enderecoCard.querySelector('.info-cep').innerText.split(' - ')[1];

        if (!editando) {
            enderecoCard.innerHTML = `
        <div class="container-endereco">
            <div class="titulo-pai">
                <input type="checkbox" class="checkbox-endereco" data-id="${idEndereco}" onclick="marcarCheckbox(${idEndereco}); event.stopPropagation();">
                <img src="/ZKFood/assets/Address.png" alt="Icone Endereço">
                <span class="titulo-endereco">ENDEREÇO PARA <span>ENTREGA</span></span>
            </div>
            <div class="conteudo-pai">
                <div class="endereco-conteudo">
                    <div class="informacao-endereco">
                        <input type="text" id="inputCep" value="${enderecoCep}">
                        <input type="text" id="inputBairro" value="${enderecoBairro}">
                        <input type="text" id="inputRua" value="${enderecoRua}">
                        <input type="text" id="inputNumero" value="${enderecoNumero}">
                        <input type="text" id="inputComplemento" value="${enderecoComplemento}">
                    </div>
                </div>
                <button class="botao-excluir" onclick="excluir(${idEndereco}); event.stopPropagation();">Excluir</button>
                <button class="botao-editar" onclick="salvar(${idEndereco}); event.stopPropagation();">Salvar</button>
            </div>
        </div>
    `;
            editando = true;
        } else {
            salvar(idEndereco);
        }
    }


    async function salvar(idEndereco) {
        const enderecoCard = document.getElementById(`card-endereco-${idEndereco}`);
        const novaRua = enderecoCard.querySelector('#inputRua').value;
        const novoBairro = enderecoCard.querySelector('#inputBairro').value;
        const novoNumero = enderecoCard.querySelector('#inputNumero').value;
        const novoCep = enderecoCard.querySelector('#inputCep').value;
        const novoComplemento = enderecoCard.querySelector('#inputComplemento').value;

        const url = `http://localhost:8080/usuarios/${idUsuario}/enderecos/${idEndereco}`;
        try {
            const resposta = await fetch(url, {
                method: "PATCH",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cep: novoCep, rua: novaRua, bairro: novoBairro, numero: novoNumero, complemento: novoComplemento })
            });

            if (resposta.ok) {
                const dadosAtualizados = await resposta.json();
                console.log('Endereço atualizado:', dadosAtualizados);

                enderecoCard.innerHTML = renderizarCardEndereco(dadosAtualizados);
                editando = false;
            } else {
                console.error('Erro ao atualizar endereço');
            }
        } catch (erro) {
            console.error('Erro:', erro);
        }
    }

    async function excluirEndereco(idEndereco) {
        const url = `http://localhost:8080/usuarios/${idUsuario}/enderecos/${idEndereco}`;
        try {
            const resposta = await fetch(url, {
                method: "DELETE",
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': '*/*'
                }
            });

            if (resposta.status === 204) {
                exibirPopup("Endereço deletado com sucesso!", "success")
                // Remover o card do endereço deletado
                const card = document.getElementById(`card-endereco-${idEndereco}`);
                if (card) {
                    card.remove();
                }

                buscar()
            } else {
                console.log(`Erro ao deletar endereço: ${resposta.status}`);
            }
        } catch (erro) {
            console.error('Erro:', erro);
        }
    }

    // Função para exibir o popup de sucesso ou erro
    function exibirPopup(mensagem, tipo) {
        const popup = document.getElementById("popup");
        const popupIcon = document.getElementById("popup-icon");
        const popupTitle = document.getElementById("popup-title");
        const popupMessage = document.getElementById("popup-message");

        if (tipo === "success") {
            popupIcon.src = "/ZKFood/assets/sucesso.png";
            popupTitle.textContent = "Sucesso!";
            popupTitle.style.color = "#33D700";
        } else {
            popupIcon.src = "/ZKFood/assets/erro.png";
            popupTitle.textContent = "Erro!";
            popupTitle.style.color = "#EB3223";
        }

        popupMessage.textContent = mensagem;
        popup.style.display = "flex";
    }

    // Função para fechar o popup
    function closePopup() {
        const popup = document.getElementById("popup");
        popup.style.display = "none";
    }

    window.onload = buscar;


</script>